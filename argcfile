#!/usr/bin/env bash

set -e

CRATES=( \
    jsona \
    jsona-ast \
    jsona-schema \
    jsona-schema-validator \
    jsona-util \
    jsona-lsp \
    jsona-cli \
)

NPMS=( \
    core \
    schema \
    util-types \
    lsp \
)

# @cmd  Preapre node_modules or other stuff
prepare() {
    (cd js && yarn)
    (cd editors/vscode && yarn)
}

# @cmd Run jsona-cli
# @arg args*
run() {
    cargo run -p jsona-cli -- $@
}

# @cmd Run web extension in chrome
# @flag --no-build
# @arg entry=test-data
chrome() {
    if [[ -z $argc_no_build ]]; then
        vscode browser
    fi
    vscode-test-web --browserType=chromium --extensionDevelopmentPath=editors/vscode $argc_entry
}

# @cmd Build vscode extension
# @flag --prod
build() {
    if [[ -n "$argc_prod" ]]; then
        (cd editors/vscode && yarn)
    else
        wasmjs all
    fi
    vscode package
}

# @cmd Build and install jsona-cli to $HOME/.cargo/bin
# @alias i
# @flag --prod
install() {
    if [[ -n $argc_prod ]]; then
        cargo build -r -p jsona-cli
        cp -f target/release/jsona $HOME/.cargo/bin/
        ls -alh $HOME/.cargo/bin/jsona
    else
        cargo build -p jsona-cli
        cp -f target/debug/jsona $HOME/.cargo/bin/
        ls -alh $HOME/.cargo/bin/jsona
    fi
}

# @cmd Build wasm and js
# @flag --debug
# @arg name[core|util-types|lsp|all]
wasmjs() {
    __run() {
        name=$1
        yarn --cwd js workspace @jsona/$name build
        ls -alh js/$name/dist
        if [[ -d editors/vscode/node_modules/@jsona/$name ]]; then
            cp -rf js/$name/dist/* editors/vscode/node_modules/@jsona/$name/dist/
        fi
    }
    if [[ -n $argc_debug ]]; then
        export WASM_DEBUG=true
    fi
    if [[ -z "$argc_name" ]] || [[ "$argc_name" == "all" ]]; then
        for name in ${NPMS[@]}; do
            __run $name
        done
    else
        __run $argc_name
    fi
}

# @cmd Build vscode extension
# @arg kind[node|browser|package]
vscode() {
    pushd editors/vscode > /dev/null
    if [[ "$1" == "browser" ]]; then
        yarn build:browser-server
        yarn build:browser-extension
    elif [[ "$1" == "node" ]]; then
        yarn build:node
    elif [[ "$1" == "package" ]]; then
        yarn package
        pkg_ver=$(node -p "require('./package.json').version")
        ls -alh vscode-jsona-$pkg_ver.vsix
    else
        yarn build
    fi
    popd > /dev/null
}

# @cmd Update crate version
# @flag --list print crate versions
# @arg crates* crate with version, e.g. jsona@0.5.1
version.crate() {
    if [[ -n "$argc_list" ]]; then
        for name in ${CRATES[@]}; do
            id=$(cargo pkgid -p $name)
            echo $name@${id##*#}
        done
    else
        for item in ${argc_crates[@]}; do
            name=${item%%@*}
            version=${item##*@}
            minor=${version%.*}
            sed -i 's/^version = ".*"/version = "'$version'"/' crates/$name/Cargo.toml
            for crate in crates/*; do
                sed -i 's|path = "../'$name'", version = ".*"|path = "../'$name'", version = "'$minor'"|' $crate/Cargo.toml
            done
        done
    fi
}


# @cmd Publish crate to carte.io
publish.crate() {
    for name in ${CRATES[@]}; do
        online_ver=$(curl -fsSL https://crates.io/api/v1/crates/$name 2>/dev/null | jq -r '.crate.newest_version')
        crate_ver=$(cargo pkgid -p $name | sed 's/.*#//')
        if [[ "$online_ver" != "$crate_ver" ]]; then
            read -p "Upgrade $name from $online_ver to $crate_ver (y/n)? " choice
            if [[ "$choice" == y ]]; then
                cargo publish -p $name
            fi
        fi
    done
}

# @cmd Update npm version
# @flag --list print npm module versions
# @arg modules* npm module with version, e.g. core@0.1.2
version.npm() {
    if [[ -n "$argc_list" ]]; then
        for name in ${NPMS[@]}; do
            pkg_ver=$(node -p "require('./js/"$name"/package.json').version")
            echo @jsona/$name@$pkg_ver
        done
    else
        for item in ${argc_modules[@]}; do
            name=${item%%@*}
            version=${item##*@}
            sed -i 's/^  "version": ".*",/  "version": "'$version'",/' js/$name/package.json
            for npm in ${NPMS[@]}; do
                sed -i 's|"@jsona/'$name'": ".*"|"@jsona/'$name'": "^'$version'"|' js/$npm/package.json
            done
            sed -i 's|"@jsona/'$name'": ".*"|"@jsona/'$name'": "^'$version'"|' editors/vscode/package.json
        done
    fi
}

# @cmd Publish to npm
publish.npm() {
    for name in ${NPMS[@]}; do
        online_ver=$(npm show @jsona/$name version)
        pkg_ver=$(node -p "require('./js/"$name"/package.json').version")
        if [[ "$online_ver" != "$pkg_ver" ]]; then
            read -p "Upgrade $name from $online_ver to $pkg_ver (y/n)? " choice
            if [[ "$choice" == y ]]; then
                (cd js/$name && npm publish)
                sleep 15
            fi
        else
            echo @jsona/$name:$pkg_ver is up to date
        fi
    done
}

# @cmd Print jsona syntax
# @arg jsona_file!
example.syntax() {
    cargo run -p jsona --example syntax -- $argc_jsona_file
}

# @cmd Parse jsona as ast
# @arg jsona_file!
example.to-ast() {
    cargo run -p jsona-ast --example to-ast -- $argc_jsona_file
}

# @cmd Generate jsona from ast
# @arg ast_file!
example.from-ast() {
    cargo run -p jsona-ast --example from-ast -- $argc_ast_file
}

# @cmd Format jsona doc
# @arg jsona_file!
example.format() {
    cargo run -p jsona --example format -- $argc_jsona_file
}

# @cmd Convert jsona jsonschema to plain jsonschema
# @arg jsona_file!
# @arg pointer
example.to-json-schema() {
    cargo run -p jsona-schema --example to-json-schema -- $argc_jsona_file $argc_pointer
}

# @cmd Get jsona schema value
# @arg jsona_file!
# @arg pointer
example.query-schema() {
    cargo run -p jsona-schema-validator --example query-schema -- $argc_jsona_file $argc_pointer
}
# @cmd Validate jsona file with a schema file
# @arg schema_file!
# @arg jsona_file!
example.validate() {
    cargo run -p jsona-schema-validator --example validate -- $argc_schema_file $argc_jsona_file
}

eval "$(argc --argc-eval $0 "$@")"
